![](/images/heros/anndata_schema.png){class="dataset_img"}

```{r load_data}
#| include: false
#| error: true

library(tidyverse)
library(jsonlite)
library(knitr)

# find files
dataset_schemas <- list.files(params$data_dir, full.names = TRUE, pattern = "*.json")

# read dataset metadata
#  -> add shape
metas <- lapply(dataset_schemas, read_json)

# extract metadata
dataset_description <- metas[[1]]$uns$dataset_description
dataset_url <- metas[[1]]$uns$dataset_url
data_url <- metas[[1]]$uns$data_url
date_created <- metas[[1]]$uns$date_created
shape <-
  if (length(metas[[1]]$struct$layers) > 0) {
    metas[[1]]$struct$layers[[1]]$shape
  } else {
    NULL
  }
shape_str <- paste(shape, collapse = " × ")

file_size <- sum(sapply(metas, function(x) x$uns$file_size))
file_size_str <- format(
  structure(file_size, class = "object_size"),
  units = "auto",
  standard = "IEC",
  digits = 2
)

```

---
dataset-size: "`r file_size_str`"
date: "`r date_created`"
dimension: "`r shape_str`"
---



```{r quick-links, results='asis'}
#| echo: false
#| column: margin

cat(glue::glue("#### Quick links

<div class='quarto-title-meta-heading'><i class='bi bi-file-earmark-text'></i> [Documentation]({dataset_url})</div>
<div class='quarto-title-meta-heading'><i class='bi bi-globe'></i> [Source]({data_url})</div>
"))


```

```{r related benchmarks, results='asis', eval=FALSE}
#| echo: false
#| column: margin

cat("#### Related benchmarks\n")

dataset_info_files <- Sys.glob("../../../results/*/data/dataset_info.json")

rel_benchmarks <- NULL

for (file in dataset_info_files) {
  benchm_datasets <- read_json(file)
  benchmark_ok <- FALSE
  for (item in benchm_datasets) {
    if (item$dataset_id == rmarkdown::metadata$`dataset-id`[1]) {
      benchmark_ok <- TRUE
    }
  }

  if (benchmark_ok) {
    parent_dir <- dirname(dirname(file))
    md_link <- paste0('[',basename(parent_dir),'](',parent_dir,')')
    rel_benchmarks <- c(rel_benchmarks, md_link)
  }
}

if (length(rel_benchmarks) == 0) {
  cat("No related benchmarks found.\n")
}

table <- kable(rel_benchmarks,"markdown", col.names = NULL)
print(table)

```


## Description

```{r description, results='asis'}
#| echo: false

cat(dataset_description)

```



## Dataset schema

```{r mod1_title}
#| echo: false
#| results: "asis"

struc_names <- c("X", "obs", "var", "obsp", "varp", "obsm", "varm", "layers", "uns")

# collect struct info across files
meta_struc <- list_rbind(map2(
  seq_along(metas),
  metas,
  function(meta_i, meta) {
    list_rbind(map2(
      names(meta$structure),
      meta$structure,
      function(name, slots) {
        if (length(slots) == 0) {
          return(NULL)
        }
        list_rbind(map(
          slots,
          function(li) {
            li$file <- meta_i
            li$struct_name <- name
            for (n in names(li)) {
              if (is.null(li[[n]])) {
                li[[n]] <- NULL
              } else if (length(li[[n]]) > 1) {
                li[[n]] <- list(li[[n]])
              }
            }
            tibble::as_tibble(li)
          }
        ))
      }
    ))
  }
)) %>%
  mutate(
    shape = map_chr(shape, paste, collapse = " × "),
    description = gsub("\n", " ", description)
  )

for (meta_i in seq_along(metas)) {
  # only print heading if there are multiple objects
  if (length(metas) > 1) {
    cat("### Modality ", meta_i, "\n")
  }

  cat(":::{.panel-tabset }\n")

  for (str_name in struc_names) {
    table_sel <- meta_struc %>%
      filter(file == meta_i, struct_name == str_name, !is.na(description)) %>%
      select(
        Name = name,
        Description = description,
        Type = type,
        Shape = shape,
        `Data type` = dtype
      )
    if (nrow(table_sel) > 0) {
      cat("## ", str_name, "\n\n")

      print(kable(table_sel, format = "markdown"))
    }
  }

  cat(":::\n")
}
```
